# Telegram Barbershop Bot (aiogram 3) ‚úÇÔ∏èü§ñ

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram-–±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –±–∞—Ä–±–µ—Ä—à–æ–ø/—Å–∞–ª–æ–Ω: –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –∏ —É—Å–ª—É–≥—É, –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã —Å —É—á—ë—Ç–æ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, —Å–æ–∑–¥–∞—ë—Ç –±—Ä–æ–Ω—å —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø–ª–∞—Ç—É (–¥–µ–º–æ) + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –≤–æ—Ä–∫–µ—Ä–æ–º.

---

## –ß—Ç–æ —É–º–µ–µ—Ç

### –ö–ª–∏–µ–Ω—Ç
- `/start` + –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- –ó–∞–ø–∏—Å—å: **–º–∞—Å—Ç–µ—Ä ‚Üí —É—Å–ª—É–≥–∞ ‚Üí –¥–∞—Ç–∞ ‚Üí —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**
- –†–∞–∑–¥–µ–ª **¬´–ú–æ–∏ –∑–∞–ø–∏—Å–∏¬ª**: —Å–ø–∏—Å–æ–∫ –±—É–¥—É—â–∏—Ö –≤–∏–∑–∏—Ç–æ–≤ + –æ—Ç–º–µ–Ω–∞
- –ö–æ–Ω—Ç—É—Ä –æ–ø–ª–∞—Ç—ã (–¥–µ–º–æ): —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞, –∫–Ω–æ–ø–∫–∞ **¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª**, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ **¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª**, –æ—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—Ç—ã

### –ê–¥–º–∏–Ω
- `/admin` (–¥–æ—Å—Ç—É–ø –ø–æ `ADMIN_IDS`)
- **–ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è**
- **–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞**
- **–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É** (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/—Ü–µ–Ω–∞/–æ–ø–∏—Å–∞–Ω–∏–µ)

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä)
- –°–µ—Ä–≤–∏—Å `reminders_worker` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
  - –∑–∞ **24 —á–∞—Å–∞**
  - –∑–∞ **1 —á–∞—Å**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö —á–µ—Ä–µ–∑ **Redis distributed lock**

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤ (–¥–≤–∏–∂–æ–∫ –≤ –ë–î)
- –¢–∞–±–ª–∏—Ü—ã –∏ CRUD –¥–ª—è:
  - —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
  - –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
  - –≤—ã—Ö–æ–¥–Ω—ã—Ö/–¥–Ω–µ–π off
- –ê–ª–≥–æ—Ä–∏—Ç–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ä—ã–≤—ã; –µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –∏–∑ `.env`.

> UI-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –ª–æ–≥–∏–∫–∞/–º–æ–¥–µ–ª–∏/–∑–∞–ø—Ä–æ—Å—ã –≥–æ—Ç–æ–≤—ã.

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Python 3.11**
- **aiogram 3.x** (FSM, inline keyboards, async)
- **PostgreSQL 16**
- **SQLAlchemy 2.x (async)** + **asyncpg**
- **Alembic** (–º–∏–≥—Ä–∞—Ü–∏–∏)
- **Redis 7** (FSM storage + lock –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞)
- **Docker / Docker Compose**
- –¢–µ—Å—Ç—ã: **pytest + pytest-asyncio + testcontainers**

---

## –ü–æ—á–µ–º—É —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äú–Ω–µ –∏–≥—Ä—É—à–µ—á–Ω—ã–π‚Äù: –∑–∞—â–∏—Ç–∞ –æ—Ç double-booking

–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç ‚Äî –±—Ä–æ–Ω—å –≤—Ä–µ–º–µ–Ω–∏ –º–∞—Å—Ç–µ—Ä–∞ –∑–∞—â–∏—â–µ–Ω–∞ **–Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î**:

- –í Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `EXCLUDE USING gist` –ø–æ:
  - `master_id`
  - `tstzrange(starts_at, ends_at, '[)')`
- –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤: `active`, `pending_payment`

–î–∞–∂–µ –µ—Å–ª–∏ –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞–∂–º—É—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è ‚Äî –≤—Ç–æ—Ä–æ–π –ø–æ–ª—É—á–∏—Ç `IntegrityError`, –±–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–ª–æ—Ç.

–≠—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ç–µ—Å—Ç–æ–º: `tests/test_overlap.py`.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
telegram_barbershop_bot/
  main.py
  app/
    config.py
    handlers/
      user.py
      admin.py
    keyboards/
      builders.py
    middlewares/
      db.py
      ban.py
    database/
      models.py
      requests.py
      session.py
    payments/
      base.py
      dummy.py
      service.py
    workers/
      reminders.py
  alembic/
    versions/
  tests/
    test_overlap.py
  docker-compose.yml
  Dockerfile
  requirements.txt
```

---

## –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### 1) –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
–°–æ–∑–¥–∞–π –±–æ—Ç–∞ –≤ `@BotFather` –∏ –ø–æ–ª—É—á–∏ —Ç–æ–∫–µ–Ω.

### 2) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```bash
cp .env.example .env
```

–ó–∞–ø–æ–ª–Ω–∏ –º–∏–Ω–∏–º—É–º:
- `BOT_TOKEN`
- `ADMIN_IDS` (—Ç–≤–æ–π Telegram ID)

### 3) –ó–∞–ø—É—Å–∫
```bash
docker compose up --build
```

–ü–æ–¥–Ω–∏–º–µ—Ç—Å—è:
- `db` ‚Äî PostgreSQL
- `redis` ‚Äî Redis
- `migrate` ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç `alembic upgrade head`
- `bot` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç (polling)
- `reminders_worker` ‚Äî –≤–æ—Ä–∫–µ—Ä –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

---

## –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ Docker)

–ù—É–∂–Ω—ã Postgres –∏ Redis (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å RedisStorage + reminders_worker).

```bash
python -m venv .venv

# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

pip install -r requirements.txt
cp .env.example .env

alembic upgrade head
python main.py
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–º–æ—Ç—Ä–∏ `.env.example`:

- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
- `ADMIN_IDS` ‚Äî CSV —Å–ø–∏—Å–æ–∫ id –∞–¥–º–∏–Ω–æ–≤ (–ø—Ä–∏–º–µ—Ä: `123,456`)
- `DATABASE_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Postgres (asyncpg)
- `TIMEZONE` ‚Äî —Ç–∞–π–º–∑–æ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Moscow`)
- `WORK_START_HOUR`, `WORK_END_HOUR` ‚Äî fallback —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (–µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ)
- `SLOT_MINUTES` ‚Äî —à–∞–≥ —Å–ª–æ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä 30/60)
- `BANNED_IDS` ‚Äî (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) CSV —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `REDIS_URL` ‚Äî Redis (FSM + lock –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞)

---

## –¢–µ—Å—Ç—ã

–¢–µ—Å—Ç `tests/test_overlap.py` –ø–æ–¥–Ω–∏–º–∞–µ—Ç Postgres —á–µ—Ä–µ–∑ `testcontainers`, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—Ä–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π.

```bash
pytest -q
```

> –í–∞–∂–Ω–æ: –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω—É–∂–µ–Ω Docker.

---

## Roadmap (–∫—É–¥–∞ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –¥–∞–ª—å—à–µ)
- –†–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ + webhooks
- –ê–¥–º–∏–Ω-UI —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
- –†–æ–ª–∏/–¥–æ—Å—Ç—É–ø—ã (RBAC) —á–µ—Ä–µ–∑ `users.role` –≤–º–µ—Å—Ç–æ `ADMIN_IDS`
- –ú–µ—Ç—Ä–∏–∫–∏/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Prometheus/structlog)
- E2E —Ç–µ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

---

## License
MIT
